name: ðŸš€ Deploy API - Batidos Pitaya

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ”‘ Configurar SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.HOSTINGER_SSH_KEY }}
        
    - name: ðŸ“¤ Sincronizar archivos (rsync)
      run: |
        echo "ðŸ”„ Sincronizando repositorio..."
        
        rsync -avz \
          --delete \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='.scripts/' \
          --exclude='.agent/' \
          --exclude='.gitignore' \
          --exclude='core/' \
          --exclude='docs/' \
          --exclude='api/uploads/' \
          -e "ssh -o StrictHostKeyChecking=no -p 65002" \
          ./ \
          ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }}:${{ secrets.HOSTINGER_PATH_API }}/
          
    - name: ðŸ”§ Configurar permisos
      run: |
        echo "ðŸ”§ Configurando permisos en el servidor..."
        
        ssh -o StrictHostKeyChecking=no -p 65002 ${{ secrets.HOSTINGER_USER }}@${{ secrets.HOSTINGER_HOST }} << 'EOF'
          cd ${{ secrets.HOSTINGER_PATH_API }}
          find api -type d -exec chmod 755 {} \;
          find api -type f -exec chmod 644 {} \;
          chmod -R 777 api/uploads/ || true
        EOF
        
    - name: âœ… Verificar deploy
      run: |
        echo "âœ… Deploy completado exitosamente"
        echo "ðŸ“ Carpeta sincronizada: api/"
        echo "ðŸ“ Carpeta excluida: api/uploads/"
        echo "ðŸŒ Sitio: https://api.batidospitaya.com"
        echo "ðŸ–¥ï¸ Servidor: ${{ secrets.HOSTINGER_HOST }}:65002"
